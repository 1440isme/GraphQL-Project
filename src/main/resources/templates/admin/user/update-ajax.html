<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout-admin}">
<head>
    <meta charset="UTF-8">
    <title>Cập nhật người dùng (AJAX + GraphQL)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        var contextPath = /*[[@{/}]]*/ '/';
        if (contextPath && !contextPath.endsWith('/')) { contextPath = contextPath + '/'; }
        var graphqlEndpoint = contextPath + 'graphql';
        /*]]>*/
    </script>
</head>
<body>
<div layout:fragment="content" class="container py-4">
    <div class="card">
        <div class="card-header">
            <h5>Cập nhật người dùng</h5>
        </div>
        <div class="card-body">
            <form id="updateUserForm">
                <input type="hidden" id="userId">
                <div class="mb-3">
                    <label class="form-label" for="userName">Tên đăng nhập</label>
                    <input class="form-control" id="userName" required>
                </div>
                <div class="mb-3">
                    <label class="form-label" for="fullName">Họ tên</label>
                    <input class="form-control" id="fullName" required>
                </div>
                <div class="mb-3">
                    <label class="form-label" for="email">Email</label>
                    <input type="email" class="form-control" id="email" required>
                </div>
                <div class="mb-3">
                    <label class="form-label" for="password">Mật khẩu</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <div class="mb-3">
                    <label class="form-label" for="phone">Điện thoại</label>
                    <input class="form-control" id="phone" required>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Lưu</button>
                    <a th:href="@{/admin/users/ajax/list}" class="btn btn-secondary">Quay lại</a>
                </div>
            </form>
        </div>
    </div>
</div>
<script type="text/javascript">
    $(function () {
        var params = new URLSearchParams(window.location.search);
        var id = params.get('id');
        if (!id) { alert('Thiếu id'); window.location.href = contextPath + 'admin/users/ajax/list'; return; }
        $('#userId').val(id);
        gqlRequest(`query($id: ID!){ userById(id: $id){ userId userName fullName email phone } }`, {id: id})
            .then(function (data) {
                var u = data && data.userById;
                if (!u) { alert('Không tìm thấy người dùng'); window.location.href = contextPath + 'admin/users/ajax/list'; return; }
                $('#userName').val(u.userName);
                $('#fullName').val(u.fullName);
                $('#email').val(u.email);
                $('#phone').val(u.phone);
            })
            .catch(function (err) { alert(err); });

        $('#updateUserForm').on('submit', function (e) {
            e.preventDefault();
            var id = $('#userId').val();
            var input = {
                userName: $('#userName').val(),
                fullName: $('#fullName').val(),
                email: $('#email').val(),
                password: $('#password').val(),
                phone: $('#phone').val()
            };
            gqlRequest(`mutation($id: ID!, $input: UserInput!){ updateUser(id: $id, input: $input){ userId } }`, {id: id, input: input})
                .then(function(){
                    alert('Cập nhật thành công');
                    window.location.href = contextPath + 'admin/users/ajax/list';
                })
                .catch(function(err){ alert('Lỗi: ' + err); });
        });
    });

    function gqlRequest(query, variables) {
        return $.ajax({
            url: graphqlEndpoint,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ query: query, variables: variables || {} })
        }).then(function (res) {
            if (res.errors) { throw (res.errors[0] && res.errors[0].message) || 'GraphQL error'; }
            return res.data;
        });
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
